# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Build and Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    permissions:
      contents: read        # Required for actions/checkout
      pull-requests: write  # Required to post the comment
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - run: df -h

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Clean up apt cache to save space
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        df -h
        # Install python dependencies (with coverage enabled)
        echo -e "\n##### Running pip install #####"
        pip install -e '.[dev]' --config-settings=cmake.args="-DENABLE_COVERAGE=ON"

    - run: df -h

    - name: Test with pytest with coverage enabled
      run: |
        # Run all tests with coverage (Python and C++)
        echo -e "\n##### Running Python tests with coverage #####"
        coverage run --source=src/ml_flashpoint --branch -m pytest -v -s

    - name: Check Python test coverage
      run: |
        # Verify python coverage thresholds
        echo -e "\n##### Verifying Python coverage thresholds #####"
        coverage report
        coverage xml -o python-coverage.xml

    - name: Python Coverage Summary
      uses: irongut/CodeCoverageSummary@v1.3.0
      with:
        filename: python-coverage.xml
        badge: true
        fail_below_min: true
        format: markdown
        hide_branch_rate: false
        hide_complexity: true
        indicators: true
        output: both
        thresholds: '90 95'

    - name: Add Python Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        recreate: true
        path: code-coverage-results.md

    - name: Check C++ test coverage
      run: |
        # Run C++ coverage check
        echo -e "\n##### Running C++ coverage check #####"
        mkdir -p htmlcov/cpp
        gcovr --root=. \
          --filter=src/ml_flashpoint \
          --exclude=".*/_deps/.*" \
          --exclude="/tmp/.*" \
          --exclude=".*pybind11.*" \
          --gcov-ignore-errors=source_not_found \
          --gcov-executable=gcov \
          --txt-metric branch \
          --html-details htmlcov/cpp/index.html \
          --xml-pretty -o cxx-coverage.xml \
          --sort uncovered-number \
          --gcov-ignore-parse-errors negative_hits.warn \
          --gcov-ignore-parse-errors suspicious_hits.warn \
          --gcov-ignore-errors=no_working_dir_found

    - name: C++ Coverage Summary
      uses: irongut/CodeCoverageSummary@v1.3.0
      with:
        filename: cxx-coverage.xml
        badge: true
        fail_below_min: false  # C++ coverage might be lower initially
        format: markdown
        hide_branch_rate: false
        hide_complexity: true
        indicators: true
        output: both
        thresholds: '80 90'

    - name: Add C++ Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        header: cpp-coverage
        recreate: true
        path: code-coverage-results.md

    - name: Archive coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          htmlcov/
          python-coverage.xml
          cxx-coverage.xml
          code-coverage-results.md

    - name: Add C++ Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request' # && false # TODO(#3): fix and then re-enable
      with:
        header: cpp-coverage
        recreate: true
        path: code-coverage-results.md

    - name: Archive coverage reports
      uses: actions/upload-artifact@v3
      with:
        name: coverage-reports
        path: |
          htmlcov/
          python-coverage.xml
          cxx-coverage.xml
          code-coverage-results.md

  lint-code:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.10" ]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Lint with ruff
      run: |
        pip install ruff==0.12.11
        ruff check .
        ruff format --check .

    - name: Lint with clang-format
      if: false # TODO(#2): fix this then re-enable
      run: |
        # Install and run C++ linter
        echo -e "\n##### Installing and running clang-format linter #####"
        sudo apt-get update && sudo apt-get install -y clang-format
        clang-format --version
        find src -name '*.cpp' -o -name '*.h' | xargs clang-format --dry-run --Werror

  lint-license:
    runs-on: ubuntu-latest
    steps:
    - name: 'Checkout Code'
      uses: 'actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8' # ratchet:actions/checkout@v5

    - name: 'Set up Go'
      uses: 'actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5' # ratchet:actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: 'Validate License Headers'
      shell: 'bash'
      run: |
        go run github.com/google/addlicense@v1.1.1 -check -s=only .
